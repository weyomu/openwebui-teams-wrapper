<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI for Teams</title>
    <script src="https://res.cdn.office.net/teams-js/2.22.0/js/MicrosoftTeams.min.js" 
            integrity="sha384-QtTBFeFlfqeTUhtFWNb4tbvhfQTIKGwCdPPTuS1LmZoE9fCCcbHPNSxpR8V5r/4Z" 
            crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #app-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 加载提示 -->
    <div id="loading">
        <div class="spinner"></div>
        <p>正在加载 OpenWebUI...</p>
    </div>
    
    <!-- 主应用iframe -->
    <iframe id="app-frame" 
            src="https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io"
            title="OpenWebUI Chatbot">
    </iframe>
    
    <script>
        console.log('Teams Wrapper initializing...');
        
        // 检查是否在Teams环境中
        const isInTeams = (function() {
            try {
                return window.parent !== window.self || 
                       navigator.userAgent.includes('Teams') ||
                       window.location.href.includes('teams.microsoft.com') ||
                       document.referrer.includes('teams.microsoft.com');
            } catch (e) {
                return true; // 如果无法访问parent，很可能在iframe中
            }
        })();
        
        console.log('Is in Teams environment:', isInTeams);
        
        if (isInTeams) {
            // 在Teams环境中，初始化Teams SDK
            try {
                microsoftTeams.initialize(() => {
                    console.log("Teams SDK initialized successfully.");
                    
                    // 通知Teams应用已加载
                    microsoftTeams.appInitialization.notifyAppLoaded();
                    console.log("App loaded notification sent.");
                    
                    // 通知Teams初始化成功
                    microsoftTeams.appInitialization.notifySuccess();
                    console.log("Success notification sent.");
                    
                    // 隐藏加载提示
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                    }, 2000);
                });
            } catch (error) {
                console.error('Teams SDK initialization failed:', error);
                // 即使初始化失败，也隐藏加载提示
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 3000);
            }
        } else {
            // 不在Teams环境中，直接重定向到原应用
            console.log('Not in Teams environment, redirecting...');
            window.location.href = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
        }
        
        // 监听iframe加载完成
        const appFrame = document.getElementById('app-frame');
        appFrame.addEventListener('load', function() {
            console.log('App iframe loaded successfully');
            // 确保加载提示被隐藏
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 1000);
        });
        
        // 监听来自iframe的消息（用于处理认证等）
        window.addEventListener('message', function(event) {
            console.log('Received message from iframe:', event.data);
            
            // 检查消息来源
            if (event.origin !== 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io') {
                return;
            }
            
            // 处理认证成功消息
            if (event.data && event.data.type === 'auth-success') {
                console.log('Authentication successful, reloading iframe...');
                // 重新加载iframe以反映认证状态
                appFrame.src = appFrame.src + (appFrame.src.includes('?') ? '&' : '?') + 'reload=' + Date.now();
            }
            
            // 处理认证失败消息
            if (event.data && event.data.type === 'auth-failed') {
                console.log('Authentication failed');
                // 可以在这里处理认证失败的情况
            }
        });
        
        // 错误处理
        appFrame.addEventListener('error', function() {
            console.error('Failed to load app iframe');
            document.getElementById('loading').innerHTML = '<p>加载失败，请稍后重试</p>';
        });
        
        // 超时处理
        setTimeout(() => {
            if (!document.getElementById('loading').classList.contains('hidden')) {
                console.log('Loading timeout, hiding loading indicator');
                document.getElementById('loading').classList.add('hidden');
            }
        }, 10000); // 10秒超时
    </script>
</body>
</html>
