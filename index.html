<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI for Teams</title>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        #app-frame { width: 100%; height: 100vh; border: none; display: block; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; z-index: 1000;
            max-width: 400px; min-width: 300px;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #0078d4; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        .teams-login {
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; max-width: 420px; min-width: 320px;
        }
        
        .login-title { 
            color: #323130; font-size: 24px; font-weight: 600; 
            margin-bottom: 12px; 
        }
        .login-subtitle { 
            color: #605e5c; font-size: 15px; margin-bottom: 24px; 
            line-height: 1.4; 
        }
        
        .auth-button {
            background: #0078d4; color: white; border: none; 
            padding: 12px 20px; border-radius: 6px; cursor: pointer; 
            font-size: 15px; font-weight: 600; margin: 6px 0; 
            min-width: 180px; transition: background 0.2s;
            display: block; width: calc(100% - 12px);
        }
        .auth-button:hover { background: #106ebe; }
        .auth-button:disabled { 
            background: #c8c8c8; cursor: not-allowed; 
        }
        
        .auth-button.secondary { background: #6b69d6; }
        .auth-button.secondary:hover { background: #5a5fc7; }
        
        .auth-button.tertiary { background: #6c757d; }
        .auth-button.tertiary:hover { background: #5a6268; }
        
        .status-text { 
            margin-top: 16px; padding: 10px; background: #f3f2f1; 
            border-radius: 6px; font-size: 13px; color: #605e5c; 
        }
        .error-text { background: #fdf2f2; color: #d13438; }
        .success-text { background: #f3f9f1; color: #107c10; }
        
        .direct-link {
            margin-top: 20px; padding-top: 20px; 
            border-top: 1px solid #edebe9; font-size: 13px;
        }
        .direct-link a {
            color: #0078d4; text-decoration: none; font-weight: 600;
        }
        .direct-link a:hover { text-decoration: underline; }

        .step-info {
            background: #f8f9fa; border-left: 4px solid #0078d4;
            padding: 10px 14px; margin: 16px 0; text-align: left;
            border-radius: 0 6px 6px 0; font-size: 13px;
        }
        .step-info .step-title {
            font-weight: 600; color: #0078d4; margin-bottom: 4px;
        }
        .step-info .step-desc {
            color: #605e5c; line-height: 1.4;
        }
        
        .logout-info {
            background: #fff3cd; border-left: 4px solid #ffc107;
            padding: 10px 14px; margin: 16px 0; text-align: left;
            border-radius: 0 6px 6px 0; font-size: 13px;
        }
        .logout-info .logout-title {
            font-weight: 600; color: #856404; margin-bottom: 4px;
        }
        .logout-info .logout-desc {
            color: #6c6c00; line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading">
        <div class="spinner"></div>
        <h3 style="color: #323130; margin: 0 0 16px 0;">Initializing Application</h3>
        <p id="loading-status" style="color: #605e5c; margin: 0;">Detecting environment...</p>
    </div>
    
    <!-- Teams login screen -->
    <div id="teams-login" class="teams-login hidden">
        <div class="login-title">OpenWebUI Login</div>
        <div class="login-subtitle">AI Chat Assistant for Microsoft Teams</div>
        
        <div id="step-info" class="step-info">
            <div class="step-title">üí° Authentication Required</div>
            <div class="step-desc">
                Please authenticate to access OpenWebUI within Teams
            </div>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="popup-login-btn" class="auth-button">
                <span>üîê</span> Authenticate
            </button>
        </div>
        
        <div style="margin: 12px 0;">
            <button id="skip-login-btn" class="auth-button secondary">
                <span>‚úÖ</span> Already Authenticated
            </button>
        </div>
        
        <div style="margin: 12px 0;">
            <button id="manual-login-btn" class="auth-button tertiary">
                <span>üîë</span> Manual Login
            </button>
        </div>
        
        <div id="auth-status" class="status-text hidden"></div>
        
        <div class="direct-link">
            <div>Need help?</div>
            <a href="https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io" target="_blank">
                Open OpenWebUI in new window
            </a>
        </div>
    </div>
    
    <!-- Main app frame -->
    <iframe id="app-frame" src="about:blank" title="OpenWebUI"></iframe>
    
    <script>
        // Global variables
        let isTeamsEnvironment = false;
        let teamsSDKLoaded = false;
        let authInProgress = false;
        let popupCompleted = false;
        let frameCheckInterval = null;
        let isLoggedOut = false;
        let lastKnownUrl = '';
        let appLoadedSuccessfully = false;
        
        // Authentication state management
        const AUTH_STORAGE_KEY = 'openwebui_teams_auth';
        const AUTH_EXPIRY_HOURS = 24;
        const LOGOUT_CHECK_KEY = 'openwebui_logout_check';
        
        // Check if user is already authenticated
        function isAlreadyAuthenticated() {
            try {
                const authData = localStorage.getItem(AUTH_STORAGE_KEY);
                if (!authData) return false;
                
                const { timestamp, authenticated } = JSON.parse(authData);
                const now = Date.now();
                const expiryTime = timestamp + (AUTH_EXPIRY_HOURS * 60 * 60 * 1000);
                
                if (now > expiryTime) {
                    localStorage.removeItem(AUTH_STORAGE_KEY);
                    return false;
                }
                
                return authenticated === true;
            } catch (error) {
                log(`Error checking auth state: ${error.message}`, 'ERROR');
                return false;
            }
        }
        
        // Store authentication state
        function storeAuthState(authenticated = true) {
            try {
                const authData = {
                    timestamp: Date.now(),
                    authenticated: authenticated
                };
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authData));
                // Clear logout check when authenticated
                localStorage.removeItem(LOGOUT_CHECK_KEY);
                log(`Auth state stored: ${authenticated}`);
            } catch (error) {
                log(`Error storing auth state: ${error.message}`, 'ERROR');
            }
        }
        
        // Clear authentication state
        function clearAuthState() {
            try {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                localStorage.setItem(LOGOUT_CHECK_KEY, Date.now().toString());
                log('Auth state cleared');
            } catch (error) {
                log(`Error clearing auth state: ${error.message}`, 'ERROR');
            }
        }
        
        // Check if logout was detected recently
        function wasRecentlyLoggedOut() {
            try {
                const logoutTime = localStorage.getItem(LOGOUT_CHECK_KEY);
                if (!logoutTime) return false;
                
                const now = Date.now();
                const timeSinceLogout = now - parseInt(logoutTime);
                
                // Consider it recent if less than 5 minutes ago
                return timeSinceLogout < (5 * 60 * 1000);
            } catch (error) {
                return false;
            }
        }
        
        // Enhanced iframe monitoring
        function startFrameMonitoring() {
            if (frameCheckInterval) return;
            
            frameCheckInterval = setInterval(() => {
                const iframe = document.getElementById('app-frame');
                if (!iframe || !iframe.src || iframe.src === 'about:blank') return;
                
                try {
                    const currentSrc = iframe.src;
                    
                    // Check if URL has changed to a login page
                    if (currentSrc !== lastKnownUrl) {
                        log(`Iframe URL changed from ${lastKnownUrl} to ${currentSrc}`);
                        lastKnownUrl = currentSrc;
                        
                        // Check for login/auth pages
                        if (isLoginPage(currentSrc) && appLoadedSuccessfully) {
                            log('Login page detected after successful app load - user logged out');
                            handleLogoutDetected();
                        }
                    }
                    
                    // Also try to check if the iframe content shows login elements
                    checkIframeContent(iframe);
                    
                } catch (error) {
                    // Expected due to CORS
                }
            }, 1500);
        }
        
        // Check if URL indicates a login page
        function isLoginPage(url) {
            const loginPatterns = [
                '/auth/',
                '/login',
                '/signin',
                '/oauth',
                'auth?',
                'login?',
                'signin?'
            ];
            
            return loginPatterns.some(pattern => url.includes(pattern));
        }
        
        // Try to detect logout by checking iframe content (when possible)
        function checkIframeContent(iframe) {
            try {
                // This will usually fail due to CORS, but worth trying
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc) {
                    const title = iframeDoc.title.toLowerCase();
                    const body = iframeDoc.body ? iframeDoc.body.innerHTML.toLowerCase() : '';
                    
                    if (title.includes('login') || title.includes('sign in') || 
                        body.includes('login') || body.includes('sign in')) {
                        if (appLoadedSuccessfully) {
                            log('Login content detected in iframe');
                            handleLogoutDetected();
                        }
                    }
                }
            } catch (error) {
                // Expected due to CORS
            }
        }
        
        // Stop frame monitoring
        function stopFrameMonitoring() {
            if (frameCheckInterval) {
                clearInterval(frameCheckInterval);
                frameCheckInterval = null;
            }
        }
        
        // Handle detected logout
        function handleLogoutDetected() {
            if (isLoggedOut) return; // Prevent multiple triggers
            
            isLoggedOut = true;
            appLoadedSuccessfully = false;
            log('Logout detected, clearing auth state and showing login interface');
            
            clearAuthState();
            stopFrameMonitoring();
            
            // Reset iframe
            const iframe = document.getElementById('app-frame');
            iframe.src = 'about:blank';
            
            // Update UI to show logout message
            const stepInfo = document.getElementById('step-info');
            if (stepInfo) {
                stepInfo.className = 'logout-info';
                stepInfo.innerHTML = `
                    <div class="logout-title">üîÑ Session Expired</div>
                    <div class="logout-desc">
                        You have been logged out. Please authenticate again to continue.
                    </div>
                `;
            }
            
            // Show login interface
            setTimeout(() => {
                showTeamsLogin();
            }, 500);
        }
        
        // Listen for iframe load events
        function setupIframeListener() {
            const iframe = document.getElementById('app-frame');
            
            iframe.addEventListener('load', () => {
                const currentSrc = iframe.src;
                log(`Iframe loaded: ${currentSrc}`);
                
                if (currentSrc && currentSrc !== 'about:blank') {
                    lastKnownUrl = currentSrc;
                    
                    // Check if this is a login page load
                    if (isLoginPage(currentSrc)) {
                        if (appLoadedSuccessfully) {
                            log('Login page loaded after app was running - logout detected');
                            setTimeout(() => {
                                if (iframe.src === currentSrc && isLoginPage(currentSrc)) {
                                    handleLogoutDetected();
                                }
                            }, 2000);
                        }
                    } else {
                        // Mark app as successfully loaded if it's not a login page
                        setTimeout(() => {
                            if (!isLoginPage(iframe.src)) {
                                appLoadedSuccessfully = true;
                                log('App loaded successfully');
                            }
                        }, 3000);
                    }
                }
            });
            
            iframe.addEventListener('error', () => {
                log('Iframe load error detected');
            });
        }
        
        // Add postMessage listener for logout detection
        function setupPostMessageListener() {
            window.addEventListener('message', (event) => {
                try {
                    if (event.data && typeof event.data === 'object') {
                        if (event.data.type === 'logout' || event.data.action === 'logout') {
                            log('Logout message received via postMessage');
                            handleLogoutDetected();
                        }
                    }
                } catch (error) {
                    // Ignore invalid messages
                }
            });
        }
        
        // Logging function
        function log(message, level = 'INFO') {
            const timestamp = new Date().toISOString().substr(11, 8);
            console.log(`[${timestamp}] [${level}] ${message}`);
        }
        
        // Status update functions
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
            log(message);
        }
        
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status-text ${type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : ''}`;
                statusEl.classList.remove('hidden');
            }
            log(message, type.toUpperCase());
        }
        
        // Hide status message
        function hideAuthStatus() {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.classList.add('hidden');
            }
        }
        
        // UI control functions
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function showTeamsLogin() {
            hideLoading();
            document.getElementById('teams-login').classList.remove('hidden');
            updateButtonStates();
            
            // Reset the step info if it was showing logout message
            const stepInfo = document.getElementById('step-info');
            if (stepInfo && stepInfo.className.includes('logout-info')) {
                // Keep the logout message for better UX
            }
        }
        
        function hideTeamsLogin() {
            document.getElementById('teams-login').classList.add('hidden');
        }
        
        function showMainApp() {
            hideLoading();
            hideTeamsLogin();
            isLoggedOut = false; // Reset logout flag
            appLoadedSuccessfully = false; // Will be set to true after successful load
            
            const iframe = document.getElementById('app-frame');
            iframe.src = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
            lastKnownUrl = iframe.src;
            log('Loading main application');
            
            // Start monitoring for logout after a delay
            setTimeout(() => {
                startFrameMonitoring();
                setupIframeListener();
                setupPostMessageListener();
            }, 2000);
        }
        
        // Update button states
        function updateButtonStates() {
            const skipBtn = document.getElementById('skip-login-btn');
            const stepInfo = document.getElementById('step-info');
            
            if (popupCompleted) {
                skipBtn.style.background = '#107c10';
                skipBtn.innerHTML = '<span>‚úÖ</span> Authentication Complete';
                if (stepInfo && !stepInfo.className.includes('logout-info')) {
                    stepInfo.style.background = '#f3f9f1';
                    stepInfo.style.borderLeftColor = '#107c10';
                }
            } else {
                skipBtn.style.background = '#6b69d6';
                skipBtn.innerHTML = '<span>‚úÖ</span> Already Authenticated';
            }
        }
        
        // Environment detection
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            const currentURL = window.location.href;
            const referrer = document.referrer;
            const isInIframe = window.parent !== window.self;
            const hasTeamsParam = new URLSearchParams(window.location.search).get('teams') === 'true';
            
            log(`User agent: ${userAgent}`);
            log(`Current URL: ${currentURL}`);
            log(`Referrer: ${referrer}`);
            log(`In iframe: ${isInIframe}`);
            log(`Teams parameter: ${hasTeamsParam}`);
            
            const isTeamsUA = userAgent.includes('Teams') || userAgent.includes('SkypeTeams');
            const isTeamsReferrer = referrer.includes('teams.microsoft.com') || referrer.includes('teams.live.com');
            
            isTeamsEnvironment = hasTeamsParam || isTeamsUA || isTeamsReferrer || 
                               (isInIframe && (isTeamsUA || isTeamsReferrer));
            
            log(`Teams environment detected: ${isTeamsEnvironment}`);
            return isTeamsEnvironment;
        }
        
        // Load Teams SDK
        function loadTeamsSDK() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('Loading Teams SDK...');
                
                const script = document.createElement('script');
                script.src = 'https://res.cdn.office.net/teams-js/2.19.0/js/MicrosoftTeams.min.js';
                script.onload = () => {
                    teamsSDKLoaded = true;
                    log('Teams SDK loaded successfully');
                    resolve();
                };
                script.onerror = () => {
                    log('Teams SDK loading failed', 'ERROR');
                    reject(new Error('Teams SDK loading failed'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Initialize Teams
        function initializeTeams() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('Initializing Teams...');
                
                try {
                    microsoftTeams.initialize(() => {
                        log('Teams initialized successfully');
                        
                        microsoftTeams.getContext((context) => {
                            log(`Teams context: user=${context.userPrincipalName}, tenant=${context.tid}`);
                            log(`App theme: ${context.theme}, language: ${context.locale}`);
                        });
                        
                        microsoftTeams.appInitialization.notifyAppLoaded();
                        microsoftTeams.appInitialization.notifySuccess();
                        log('Teams app status notified');
                        
                        resolve();
                    });
                } catch (error) {
                    log(`Teams initialization failed: ${error.message}`, 'ERROR');
                    reject(error);
                }
            });
        }
        
        // Popup authentication
        function performPopupAuth() {
            if (!teamsSDKLoaded || authInProgress) return;
            
            authInProgress = true;
            updateAuthStatus('Opening authentication window...', 'info');
            
            setButtonsDisabled(true);
            
            microsoftTeams.authentication.authenticate({
                url: 'https://yellow-pebble-05fc00400.2.azurestaticapps.net/auth-popup.html',
                width: 600,
                height: 535,
                successCallback: function(result) {
                    log(`Popup authentication successful: ${result}`);
                    updateAuthStatus('Authentication successful!', 'success');
                    popupCompleted = true;
                    storeAuthState(true);
                    updateButtonStates();
                    
                    authInProgress = false;
                    setButtonsDisabled(false);
                    
                    // Auto-login after successful authentication
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                },
                failureCallback: function(reason) {
                    log(`Popup authentication failed: ${reason}`, 'ERROR');
                    
                    if (reason === 'CancelledByUser' || reason.includes('cancelled') || reason.includes('canceled')) {
                        log('User cancelled authentication', 'INFO');
                        hideAuthStatus();
                    } else {
                        updateAuthStatus(`Authentication failed: ${reason}`, 'error');
                    }
                    
                    authInProgress = false;
                    setButtonsDisabled(false);
                }
            });
        }
        
        // Direct login
        function directLogin() {
            log('User chose direct login');
            
            if (popupCompleted) {
                updateAuthStatus('Logging in with completed authentication...', 'info');
                storeAuthState(true);
            } else {
                updateAuthStatus('Attempting direct login...', 'info');
                storeAuthState(true);
            }
            
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // Manual login
        function manualLogin() {
            log('User chose manual login');
            updateAuthStatus('Redirecting to login page...', 'info');
            storeAuthState(true);
            
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // Set button disabled state
        function setButtonsDisabled(disabled) {
            document.getElementById('popup-login-btn').disabled = disabled;
            document.getElementById('skip-login-btn').disabled = disabled;
            document.getElementById('manual-login-btn').disabled = disabled;
        }
        
        // Main initialization flow
        async function initialize() {
            log('Application initialization started');
            
            const isTeams = detectEnvironment();
            
            if (isTeams) {
                updateLoadingStatus('Teams environment detected');
                
                // Check if user was recently logged out
                if (wasRecentlyLoggedOut()) {
                    log('Recent logout detected, showing login interface');
                    updateLoadingStatus('Session expired, please login again...');
                    setTimeout(() => {
                        const stepInfo = document.getElementById('step-info');
                        if (stepInfo) {
                            stepInfo.className = 'logout-info';
                            stepInfo.innerHTML = `
                                <div class="logout-title">üîÑ Session Expired</div>
                                <div class="logout-desc">
                                    You have been logged out. Please authenticate again to continue.
                                </div>
                            `;
                        }
                        showTeamsLogin();
                    }, 1000);
                    return;
                }
                
                // Check if already authenticated
                if (isAlreadyAuthenticated()) {
                    log('User already authenticated, attempting to load app');
                    updateLoadingStatus('Already authenticated, loading app...');
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                    return;
                }
                
                try {
                    await loadTeamsSDK();
                    await initializeTeams();
                    
                    updateLoadingStatus('Initialization complete, showing login options...');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 1000);
                    
                } catch (error) {
                    log(`Teams environment initialization failed: ${error.message}`, 'ERROR');
                    updateLoadingStatus('Initialization failed, showing login options');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 2000);
                }
                
            } else {
                updateLoadingStatus('Browser environment detected, redirecting...');
                log('Regular browser environment, direct redirect');
                
                setTimeout(() => {
                    window.location.href = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
                }, 1500);
            }
        }
        
        // Event listeners
        document.getElementById('popup-login-btn').addEventListener('click', performPopupAuth);
        document.getElementById('skip-login-btn').addEventListener('click', directLogin);
        document.getElementById('manual-login-btn').addEventListener('click', manualLogin);
        
        // Timeout protection
        setTimeout(() => {
            if (!document.getElementById('loading').classList.contains('hidden')) {
                log('Initialization timeout, showing login interface', 'WARNING');
                showTeamsLogin();
            }
        }, 15000);
        
        // Start initialization
        initialize();
    </script>
</body>
</html>
