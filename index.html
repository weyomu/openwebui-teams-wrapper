<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI for Teams</title>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        #app-frame { width: 100%; height: 100vh; border: none; display: block; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; z-index: 1000;
            max-width: 400px; min-width: 300px;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #0078d4; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        .teams-login {
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; max-width: 450px; min-width: 350px;
        }
        
        .login-title { 
            color: #323130; font-size: 24px; font-weight: 600; 
            margin-bottom: 16px; 
        }
        .login-subtitle { 
            color: #605e5c; font-size: 16px; margin-bottom: 32px; 
            line-height: 1.4; 
        }
        
        .auth-button {
            background: #0078d4; color: white; border: none; 
            padding: 14px 24px; border-radius: 6px; cursor: pointer; 
            font-size: 16px; font-weight: 600; margin: 8px; 
            min-width: 200px; transition: background 0.2s;
            display: block; width: calc(100% - 16px);
        }
        .auth-button:hover { background: #106ebe; }
        .auth-button:disabled { 
            background: #c8c8c8; cursor: not-allowed; 
        }
        
        .auth-button.secondary { background: #6b69d6; }
        .auth-button.secondary:hover { background: #5a5fc7; }
        
        .auth-button.tertiary { background: #6c757d; }
        .auth-button.tertiary:hover { background: #5a6268; }
        
        .status-text { 
            margin-top: 20px; padding: 12px; background: #f3f2f1; 
            border-radius: 6px; font-size: 14px; color: #605e5c; 
        }
        .error-text { background: #fdf2f2; color: #d13438; }
        .success-text { background: #f3f9f1; color: #107c10; }
        
        .direct-link {
            margin-top: 24px; padding-top: 24px; 
            border-top: 1px solid #edebe9; font-size: 14px;
        }
        .direct-link a {
            color: #0078d4; text-decoration: none; font-weight: 600;
        }
        .direct-link a:hover { text-decoration: underline; }

        .step-info {
            background: #f8f9fa; border-left: 4px solid #0078d4;
            padding: 12px 16px; margin: 20px 0; text-align: left;
            border-radius: 0 6px 6px 0; font-size: 14px;
        }
        .step-info .step-title {
            font-weight: 600; color: #0078d4; margin-bottom: 4px;
        }
        .step-info .step-desc {
            color: #605e5c; line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- åˆå§‹åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <h3 style="color: #323130; margin: 0 0 16px 0;">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨</h3>
        <p id="loading-status" style="color: #605e5c; margin: 0;">æ£€æµ‹è¿è¡Œç¯å¢ƒ...</p>
    </div>
    
    <!-- Teamsç™»å½•ç•Œé¢ -->
    <div id="teams-login" class="teams-login hidden">
        <div class="login-title">OpenWebUI ç™»å½•</div>
        <div class="login-subtitle">åœ¨Microsoft Teamsä¸­ä½¿ç”¨AIèŠå¤©åŠ©æ‰‹</div>
        
        <div class="step-info">
            <div class="step-title">ğŸ’¡ æ¨èç™»å½•æµç¨‹</div>
            <div class="step-desc">
                1. å…ˆç‚¹å‡»"å¼¹çª—éªŒè¯"è¿›è¡Œèº«ä»½è®¤è¯<br>
                2. è®¤è¯å®Œæˆåç‚¹å‡»"æˆ‘å·²éªŒè¯ï¼Œç›´æ¥ç™»å½•"
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <button id="popup-login-btn" class="auth-button">
                <span>ğŸªŸ</span> å¼¹çª—éªŒè¯
            </button>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="skip-login-btn" class="auth-button secondary">
                <span>âœ…</span> æˆ‘å·²éªŒè¯ï¼Œç›´æ¥ç™»å½•
            </button>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="manual-login-btn" class="auth-button tertiary">
                <span>ğŸ”‘</span> ä½¿ç”¨è´¦å·å¯†ç ç™»å½•
            </button>
        </div>
        
        <div id="auth-status" class="status-text hidden"></div>
        
        <div class="direct-link">
            <div>é‡åˆ°é—®é¢˜ï¼Ÿ</div>
            <a href="https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io" target="_blank">
                åœ¨æ–°çª—å£ä¸­æ‰“å¼€OpenWebUI
            </a>
        </div>
    </div>
    
    <!-- ä¸»åº”ç”¨æ¡†æ¶ -->
    <iframe id="app-frame" src="about:blank" title="OpenWebUI"></iframe>
    
    <script>
        // å…¨å±€å˜é‡
        let isTeamsEnvironment = false;
        let teamsSDKLoaded = false;
        let authInProgress = false;
        let popupCompleted = false; // æ–°å¢ï¼šè·Ÿè¸ªå¼¹çª—æ˜¯å¦å®Œæˆ
        
        // æ—¥å¿—å‡½æ•°
        function log(message, level = 'INFO') {
            const timestamp = new Date().toISOString().substr(11, 8);
            console.log(`[${timestamp}] [${level}] ${message}`);
        }
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
            log(message);
        }
        
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status-text ${type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : ''}`;
                statusEl.classList.remove('hidden');
            }
            log(message, type.toUpperCase());
        }
        
        // ç•Œé¢æ§åˆ¶å‡½æ•°
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function showTeamsLogin() {
            hideLoading();
            document.getElementById('teams-login').classList.remove('hidden');
            updateButtonStates();
        }
        
        function hideTeamsLogin() {
            document.getElementById('teams-login').classList.add('hidden');
        }
        
        function showMainApp() {
            hideLoading();
            hideTeamsLogin();
            const iframe = document.getElementById('app-frame');
            iframe.src = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
            log('åŠ è½½ä¸»åº”ç”¨');
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            const skipBtn = document.getElementById('skip-login-btn');
            const stepInfo = document.querySelector('.step-info');
            
            if (popupCompleted) {
                skipBtn.style.background = '#107c10'; // ç»¿è‰²è¡¨ç¤ºå¯ä»¥ä½¿ç”¨
                skipBtn.innerHTML = '<span>âœ…</span> éªŒè¯å®Œæˆï¼Œç‚¹å‡»ç™»å½•';
                stepInfo.style.background = '#f3f9f1';
                stepInfo.style.borderLeftColor = '#107c10';
            } else {
                skipBtn.style.background = '#6b69d6'; // é»˜è®¤é¢œè‰²
                skipBtn.innerHTML = '<span>âœ…</span> æˆ‘å·²éªŒè¯ï¼Œç›´æ¥ç™»å½•';
            }
        }
        
        // ç¯å¢ƒæ£€æµ‹
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            const currentURL = window.location.href;
            const referrer = document.referrer;
            const isInIframe = window.parent !== window.self;
            const hasTeamsParam = new URLSearchParams(window.location.search).get('teams') === 'true';
            
            log(`ç”¨æˆ·ä»£ç†: ${userAgent}`);
            log(`å½“å‰URL: ${currentURL}`);
            log(`å¼•ç”¨é¡µ: ${referrer}`);
            log(`åœ¨iframeä¸­: ${isInIframe}`);
            log(`Teamså‚æ•°: ${hasTeamsParam}`);
            
            // åˆ¤æ–­æ˜¯å¦åœ¨Teamsç¯å¢ƒä¸­
            const isTeamsUA = userAgent.includes('Teams') || userAgent.includes('SkypeTeams');
            const isTeamsReferrer = referrer.includes('teams.microsoft.com') || referrer.includes('teams.live.com');
            
            isTeamsEnvironment = hasTeamsParam || isTeamsUA || isTeamsReferrer || 
                               (isInIframe && (isTeamsUA || isTeamsReferrer));
            
            log(`Teamsç¯å¢ƒæ£€æµ‹ç»“æœ: ${isTeamsEnvironment}`);
            return isTeamsEnvironment;
        }
        
        // Teams SDKåŠ è½½
        function loadTeamsSDK() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('åŠ è½½Teams SDK...');
                
                const script = document.createElement('script');
                script.src = 'https://res.cdn.office.net/teams-js/2.19.0/js/MicrosoftTeams.min.js';
                script.onload = () => {
                    teamsSDKLoaded = true;
                    log('Teams SDKåŠ è½½æˆåŠŸ');
                    resolve();
                };
                script.onerror = () => {
                    log('Teams SDKåŠ è½½å¤±è´¥', 'ERROR');
                    reject(new Error('Teams SDKåŠ è½½å¤±è´¥'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Teamsåˆå§‹åŒ–
        function initializeTeams() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('åˆå§‹åŒ–Teams...');
                
                try {
                    microsoftTeams.initialize(() => {
                        log('Teamsåˆå§‹åŒ–æˆåŠŸ');
                        
                        // è·å–Teamsä¸Šä¸‹æ–‡ä¿¡æ¯
                        microsoftTeams.getContext((context) => {
                            log(`Teamsä¸Šä¸‹æ–‡: ç”¨æˆ·=${context.userPrincipalName}, ç§Ÿæˆ·=${context.tid}`);
                            log(`åº”ç”¨ä¸»é¢˜: ${context.theme}, è¯­è¨€: ${context.locale}`);
                        });
                        
                        // é€šçŸ¥Teamsåº”ç”¨å·²åŠ è½½
                        microsoftTeams.appInitialization.notifyAppLoaded();
                        microsoftTeams.appInitialization.notifySuccess();
                        log('å·²é€šçŸ¥Teamsåº”ç”¨çŠ¶æ€');
                        
                        resolve();
                    });
                } catch (error) {
                    log(`Teamsåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'ERROR');
                    reject(error);
                }
            });
        }
        
        // å¼¹çª—éªŒè¯
        function performPopupAuth() {
            if (!teamsSDKLoaded || authInProgress) return;
            
            authInProgress = true;
            updateAuthStatus('æ­£åœ¨æ‰“å¼€éªŒè¯çª—å£...', 'info');
            
            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
            setButtonsDisabled(true);
            
            microsoftTeams.authentication.authenticate({
                url: 'https://yellow-pebble-05fc00400.2.azurestaticapps.net/auth-popup.html',
                width: 600,
                height: 535,
                successCallback: function(result) {
                    log(`å¼¹çª—éªŒè¯æˆåŠŸ: ${result}`);
                    updateAuthStatus('éªŒè¯æˆåŠŸï¼ç°åœ¨å¯ä»¥ç›´æ¥ç™»å½•äº†', 'success');
                    popupCompleted = true;
                    updateButtonStates();
                    
                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    authInProgress = false;
                    setButtonsDisabled(false);
                    
                    // è‡ªåŠ¨æç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡»ç›´æ¥ç™»å½•
                    setTimeout(() => {
                        updateAuthStatus('âœ… éªŒè¯å®Œæˆï¼Œè¯·ç‚¹å‡»"éªŒè¯å®Œæˆï¼Œç‚¹å‡»ç™»å½•"æŒ‰é’®', 'success');
                    }, 2000);
                },
                failureCallback: function(reason) {
                    log(`å¼¹çª—éªŒè¯å¤±è´¥: ${reason}`, 'ERROR');
                    updateAuthStatus(`éªŒè¯å¤±è´¥: ${reason}`, 'error');
                    
                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    authInProgress = false;
                    setButtonsDisabled(false);
                }
            });
        }
        
        // ç›´æ¥ç™»å½•ï¼ˆåŸºäºå·²å®Œæˆçš„éªŒè¯ï¼‰
        function directLogin() {
            log('ç”¨æˆ·é€‰æ‹©ç›´æ¥ç™»å½•');
            
            if (popupCompleted) {
                updateAuthStatus('åŸºäºå·²å®Œæˆçš„éªŒè¯è¿›è¡Œç™»å½•...', 'info');
            } else {
                updateAuthStatus('å°è¯•ç›´æ¥ç™»å½•...', 'info');
            }
            
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // æ‰‹åŠ¨ç™»å½•ï¼ˆè´¦å·å¯†ç ï¼‰
        function manualLogin() {
            log('ç”¨æˆ·é€‰æ‹©æ‰‹åŠ¨ç™»å½•');
            updateAuthStatus('è·³è½¬åˆ°ç™»å½•é¡µé¢...', 'info');
            
            // ç›´æ¥åŠ è½½ä¸»åº”ç”¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨é‚£é‡Œæ‰‹åŠ¨ç™»å½•
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // è®¾ç½®æŒ‰é’®ç¦ç”¨çŠ¶æ€
        function setButtonsDisabled(disabled) {
            document.getElementById('popup-login-btn').disabled = disabled;
            document.getElementById('skip-login-btn').disabled = disabled;
            document.getElementById('manual-login-btn').disabled = disabled;
        }
        
        // ä¸»åˆå§‹åŒ–æµç¨‹
        async function initialize() {
            log('åº”ç”¨å¼€å§‹åˆå§‹åŒ–');
            
            // æ£€æµ‹ç¯å¢ƒ
            const isTeams = detectEnvironment();
            
            if (isTeams) {
                updateLoadingStatus('æ£€æµ‹åˆ°Teamsç¯å¢ƒ');
                
                try {
                    // åŠ è½½Teams SDK
                    await loadTeamsSDK();
                    
                    // åˆå§‹åŒ–Teams
                    await initializeTeams();
                    
                    updateLoadingStatus('åˆå§‹åŒ–å®Œæˆï¼Œæ˜¾ç¤ºç™»å½•é€‰é¡¹...');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 1000);
                    
                } catch (error) {
                    log(`Teamsç¯å¢ƒåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'ERROR');
                    updateLoadingStatus('åˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•é€‰é¡¹');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 2000);
                }
                
            } else {
                // æ™®é€šæµè§ˆå™¨ç¯å¢ƒ
                updateLoadingStatus('æ£€æµ‹åˆ°æ™®é€šæµè§ˆå™¨ï¼Œé‡å®šå‘ä¸­...');
                log('æ™®é€šæµè§ˆå™¨ç¯å¢ƒï¼Œç›´æ¥é‡å®šå‘');
                
                setTimeout(() => {
                    window.location.href = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
                }, 1500);
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('popup-login-btn').addEventListener('click', performPopupAuth);
        document.getElementById('skip-login-btn').addEventListener('click', directLogin);
        document.getElementById('manual-login-btn').addEventListener('click', manualLogin);
        
        // è¶…æ—¶ä¿æŠ¤
        setTimeout(() => {
            if (!document.getElementById('loading').classList.contains('hidden')) {
                log('åˆå§‹åŒ–è¶…æ—¶ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢', 'WARNING');
                showTeamsLogin();
            }
        }, 15000);
        
        // å¼€å§‹åˆå§‹åŒ–
        initialize();
    </script>
</body>
</html>
