<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI for Teams</title>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        #app-frame { width: 100%; height: 100vh; border: none; display: block; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; z-index: 1000;
            max-width: 400px; min-width: 300px;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #0078d4; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        .teams-login {
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; max-width: 450px; min-width: 350px;
        }
        
        .login-title { 
            color: #323130; font-size: 24px; font-weight: 600; 
            margin-bottom: 16px; 
        }
        .login-subtitle { 
            color: #605e5c; font-size: 16px; margin-bottom: 32px; 
            line-height: 1.4; 
        }
        
        .auth-button {
            background: #0078d4; color: white; border: none; 
            padding: 14px 24px; border-radius: 6px; cursor: pointer; 
            font-size: 16px; font-weight: 600; margin: 8px; 
            min-width: 200px; transition: background 0.2s;
            display: block; width: calc(100% - 16px);
        }
        .auth-button:hover { background: #106ebe; }
        .auth-button:disabled { 
            background: #c8c8c8; cursor: not-allowed; 
        }
        
        .auth-button.secondary { background: #6b69d6; }
        .auth-button.secondary:hover { background: #5a5fc7; }
        
        .auth-button.tertiary { background: #6c757d; }
        .auth-button.tertiary:hover { background: #5a6268; }
        
        .status-text { 
            margin-top: 20px; padding: 12px; background: #f3f2f1; 
            border-radius: 6px; font-size: 14px; color: #605e5c; 
        }
        .error-text { background: #fdf2f2; color: #d13438; }
        .success-text { background: #f3f9f1; color: #107c10; }
        
        .direct-link {
            margin-top: 24px; padding-top: 24px; 
            border-top: 1px solid #edebe9; font-size: 14px;
        }
        .direct-link a {
            color: #0078d4; text-decoration: none; font-weight: 600;
        }
        .direct-link a:hover { text-decoration: underline; }

        .step-info {
            background: #f8f9fa; border-left: 4px solid #0078d4;
            padding: 12px 16px; margin: 20px 0; text-align: left;
            border-radius: 0 6px 6px 0; font-size: 14px;
        }
        .step-info .step-title {
            font-weight: 600; color: #0078d4; margin-bottom: 4px;
        }
        .step-info .step-desc {
            color: #605e5c; line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- 初始加载界面 -->
    <div id="loading">
        <div class="spinner"></div>
        <h3 style="color: #323130; margin: 0 0 16px 0;">正在初始化应用</h3>
        <p id="loading-status" style="color: #605e5c; margin: 0;">检测运行环境...</p>
    </div>
    
    <!-- Teams登录界面 -->
    <div id="teams-login" class="teams-login hidden">
        <div class="login-title">OpenWebUI 登录</div>
        <div class="login-subtitle">在Microsoft Teams中使用AI聊天助手</div>
        
        <div class="step-info">
            <div class="step-title">💡 推荐登录流程</div>
            <div class="step-desc">
                1. 先点击"弹窗验证"进行身份认证<br>
                2. 认证完成后点击"我已验证，直接登录"
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <button id="popup-login-btn" class="auth-button">
                <span>🪟</span> 弹窗验证
            </button>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="skip-login-btn" class="auth-button secondary">
                <span>✅</span> 我已验证，直接登录
            </button>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="manual-login-btn" class="auth-button tertiary">
                <span>🔑</span> 使用账号密码登录
            </button>
        </div>
        
        <div id="auth-status" class="status-text hidden"></div>
        
        <div class="direct-link">
            <div>遇到问题？</div>
            <a href="https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io" target="_blank">
                在新窗口中打开OpenWebUI
            </a>
        </div>
    </div>
    
    <!-- 主应用框架 -->
    <iframe id="app-frame" src="about:blank" title="OpenWebUI"></iframe>
    
    <script>
        // 全局变量
        let isTeamsEnvironment = false;
        let teamsSDKLoaded = false;
        let authInProgress = false;
        let popupCompleted = false; // 新增：跟踪弹窗是否完成
        
        // 日志函数
        function log(message, level = 'INFO') {
            const timestamp = new Date().toISOString().substr(11, 8);
            console.log(`[${timestamp}] [${level}] ${message}`);
        }
        
        // 状态更新函数
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
            log(message);
        }
        
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status-text ${type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : ''}`;
                statusEl.classList.remove('hidden');
            }
            log(message, type.toUpperCase());
        }
        
        // 界面控制函数
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function showTeamsLogin() {
            hideLoading();
            document.getElementById('teams-login').classList.remove('hidden');
            updateButtonStates();
        }
        
        function hideTeamsLogin() {
            document.getElementById('teams-login').classList.add('hidden');
        }
        
        function showMainApp() {
            hideLoading();
            hideTeamsLogin();
            const iframe = document.getElementById('app-frame');
            iframe.src = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
            log('加载主应用');
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const skipBtn = document.getElementById('skip-login-btn');
            const stepInfo = document.querySelector('.step-info');
            
            if (popupCompleted) {
                skipBtn.style.background = '#107c10'; // 绿色表示可以使用
                skipBtn.innerHTML = '<span>✅</span> 验证完成，点击登录';
                stepInfo.style.background = '#f3f9f1';
                stepInfo.style.borderLeftColor = '#107c10';
            } else {
                skipBtn.style.background = '#6b69d6'; // 默认颜色
                skipBtn.innerHTML = '<span>✅</span> 我已验证，直接登录';
            }
        }
        
        // 环境检测
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            const currentURL = window.location.href;
            const referrer = document.referrer;
            const isInIframe = window.parent !== window.self;
            const hasTeamsParam = new URLSearchParams(window.location.search).get('teams') === 'true';
            
            log(`用户代理: ${userAgent}`);
            log(`当前URL: ${currentURL}`);
            log(`引用页: ${referrer}`);
            log(`在iframe中: ${isInIframe}`);
            log(`Teams参数: ${hasTeamsParam}`);
            
            // 判断是否在Teams环境中
            const isTeamsUA = userAgent.includes('Teams') || userAgent.includes('SkypeTeams');
            const isTeamsReferrer = referrer.includes('teams.microsoft.com') || referrer.includes('teams.live.com');
            
            isTeamsEnvironment = hasTeamsParam || isTeamsUA || isTeamsReferrer || 
                               (isInIframe && (isTeamsUA || isTeamsReferrer));
            
            log(`Teams环境检测结果: ${isTeamsEnvironment}`);
            return isTeamsEnvironment;
        }
        
        // Teams SDK加载
        function loadTeamsSDK() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('加载Teams SDK...');
                
                const script = document.createElement('script');
                script.src = 'https://res.cdn.office.net/teams-js/2.19.0/js/MicrosoftTeams.min.js';
                script.onload = () => {
                    teamsSDKLoaded = true;
                    log('Teams SDK加载成功');
                    resolve();
                };
                script.onerror = () => {
                    log('Teams SDK加载失败', 'ERROR');
                    reject(new Error('Teams SDK加载失败'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Teams初始化
        function initializeTeams() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('初始化Teams...');
                
                try {
                    microsoftTeams.initialize(() => {
                        log('Teams初始化成功');
                        
                        // 获取Teams上下文信息
                        microsoftTeams.getContext((context) => {
                            log(`Teams上下文: 用户=${context.userPrincipalName}, 租户=${context.tid}`);
                            log(`应用主题: ${context.theme}, 语言: ${context.locale}`);
                        });
                        
                        // 通知Teams应用已加载
                        microsoftTeams.appInitialization.notifyAppLoaded();
                        microsoftTeams.appInitialization.notifySuccess();
                        log('已通知Teams应用状态');
                        
                        resolve();
                    });
                } catch (error) {
                    log(`Teams初始化失败: ${error.message}`, 'ERROR');
                    reject(error);
                }
            });
        }
        
        // 弹窗验证
        function performPopupAuth() {
            if (!teamsSDKLoaded || authInProgress) return;
            
            authInProgress = true;
            updateAuthStatus('正在打开验证窗口...', 'info');
            
            // 禁用所有按钮
            setButtonsDisabled(true);
            
            microsoftTeams.authentication.authenticate({
                url: 'https://yellow-pebble-05fc00400.2.azurestaticapps.net/auth-popup.html',
                width: 600,
                height: 535,
                successCallback: function(result) {
                    log(`弹窗验证成功: ${result}`);
                    updateAuthStatus('验证成功！现在可以直接登录了', 'success');
                    popupCompleted = true;
                    updateButtonStates();
                    
                    // 重新启用按钮
                    authInProgress = false;
                    setButtonsDisabled(false);
                    
                    // 自动提示用户可以点击直接登录
                    setTimeout(() => {
                        updateAuthStatus('✅ 验证完成，请点击"验证完成，点击登录"按钮', 'success');
                    }, 2000);
                },
                failureCallback: function(reason) {
                    log(`弹窗验证失败: ${reason}`, 'ERROR');
                    updateAuthStatus(`验证失败: ${reason}`, 'error');
                    
                    // 重新启用按钮
                    authInProgress = false;
                    setButtonsDisabled(false);
                }
            });
        }
        
        // 直接登录（基于已完成的验证）
        function directLogin() {
            log('用户选择直接登录');
            
            if (popupCompleted) {
                updateAuthStatus('基于已完成的验证进行登录...', 'info');
            } else {
                updateAuthStatus('尝试直接登录...', 'info');
            }
            
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // 手动登录（账号密码）
        function manualLogin() {
            log('用户选择手动登录');
            updateAuthStatus('跳转到登录页面...', 'info');
            
            // 直接加载主应用，用户可以在那里手动登录
            setTimeout(() => {
                showMainApp();
            }, 1000);
        }
        
        // 设置按钮禁用状态
        function setButtonsDisabled(disabled) {
            document.getElementById('popup-login-btn').disabled = disabled;
            document.getElementById('skip-login-btn').disabled = disabled;
            document.getElementById('manual-login-btn').disabled = disabled;
        }
        
        // 主初始化流程
        async function initialize() {
            log('应用开始初始化');
            
            // 检测环境
            const isTeams = detectEnvironment();
            
            if (isTeams) {
                updateLoadingStatus('检测到Teams环境');
                
                try {
                    // 加载Teams SDK
                    await loadTeamsSDK();
                    
                    // 初始化Teams
                    await initializeTeams();
                    
                    updateLoadingStatus('初始化完成，显示登录选项...');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 1000);
                    
                } catch (error) {
                    log(`Teams环境初始化失败: ${error.message}`, 'ERROR');
                    updateLoadingStatus('初始化失败，显示登录选项');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 2000);
                }
                
            } else {
                // 普通浏览器环境
                updateLoadingStatus('检测到普通浏览器，重定向中...');
                log('普通浏览器环境，直接重定向');
                
                setTimeout(() => {
                    window.location.href = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
                }, 1500);
            }
        }
        
        // 事件监听器
        document.getElementById('popup-login-btn').addEventListener('click', performPopupAuth);
        document.getElementById('skip-login-btn').addEventListener('click', directLogin);
        document.getElementById('manual-login-btn').addEventListener('click', manualLogin);
        
        // 超时保护
        setTimeout(() => {
            if (!document.getElementById('loading').classList.contains('hidden')) {
                log('初始化超时，显示登录界面', 'WARNING');
                showTeamsLogin();
            }
        }, 15000);
        
        // 开始初始化
        initialize();
    </script>
</body>
</html>
