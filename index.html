<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI for Teams</title>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        #app-frame { width: 100%; height: 100vh; border: none; display: block; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; z-index: 1000;
            max-width: 400px; min-width: 300px;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #0078d4; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        .teams-login {
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; max-width: 450px; min-width: 350px;
        }
        
        .login-title { 
            color: #323130; font-size: 24px; font-weight: 600; 
            margin-bottom: 16px; 
        }
        .login-subtitle { 
            color: #605e5c; font-size: 16px; margin-bottom: 32px; 
            line-height: 1.4; 
        }
        
        .auth-button {
            background: #0078d4; color: white; border: none; 
            padding: 14px 24px; border-radius: 6px; cursor: pointer; 
            font-size: 16px; font-weight: 600; margin: 8px; 
            min-width: 200px; transition: background 0.2s;
        }
        .auth-button:hover { background: #106ebe; }
        .auth-button:disabled { 
            background: #c8c8c8; cursor: not-allowed; 
        }
        
        .status-text { 
            margin-top: 20px; padding: 12px; background: #f3f2f1; 
            border-radius: 6px; font-size: 14px; color: #605e5c; 
        }
        .error-text { background: #fdf2f2; color: #d13438; }
        .success-text { background: #f3f9f1; color: #107c10; }
        
        .direct-link {
            margin-top: 24px; padding-top: 24px; 
            border-top: 1px solid #edebe9; font-size: 14px;
        }
        .direct-link a {
            color: #0078d4; text-decoration: none; font-weight: 600;
        }
        .direct-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- åˆå§‹åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <h3 style="color: #323130; margin: 0 0 16px 0;">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨</h3>
        <p id="loading-status" style="color: #605e5c; margin: 0;">æ£€æµ‹è¿è¡Œç¯å¢ƒ...</p>
    </div>
    
    <!-- Teamsç™»å½•ç•Œé¢ -->
    <div id="teams-login" class="teams-login hidden">
        <div class="login-title">OpenWebUI ç™»å½•</div>
        <div class="login-subtitle">åœ¨Microsoft Teamsä¸­ä½¿ç”¨AIèŠå¤©åŠ©æ‰‹</div>
        
        <div style="margin: 24px 0;">
            <button id="sso-login-btn" class="auth-button">
                <span>ğŸ”</span> ä½¿ç”¨Teamsè´¦æˆ·ç™»å½•
            </button>
        </div>
        
        <div style="margin: 16px 0;">
            <button id="popup-login-btn" class="auth-button" style="background: #6b69d6;">
                <span>ğŸªŸ</span> å¼¹çª—ç™»å½•
            </button>
        </div>
        
        <div id="auth-status" class="status-text hidden"></div>
        
        <div class="direct-link">
            <div>é‡åˆ°é—®é¢˜ï¼Ÿ</div>
            <a href="https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io" target="_blank">
                åœ¨æ–°çª—å£ä¸­æ‰“å¼€OpenWebUI
            </a>
        </div>
    </div>
    
    <!-- ä¸»åº”ç”¨æ¡†æ¶ -->
    <iframe id="app-frame" src="about:blank" title="OpenWebUI"></iframe>
    
    <script>
        // å…¨å±€å˜é‡
        let isTeamsEnvironment = false;
        let teamsSDKLoaded = false;
        let authInProgress = false;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, level = 'INFO') {
            const timestamp = new Date().toISOString().substr(11, 8);
            console.log(`[${timestamp}] [${level}] ${message}`);
        }
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
            log(message);
        }
        
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status-text ${type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : ''}`;
                statusEl.classList.remove('hidden');
            }
            log(message, type.toUpperCase());
        }
        
        // ç•Œé¢æ§åˆ¶å‡½æ•°
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function showTeamsLogin() {
            hideLoading();
            document.getElementById('teams-login').classList.remove('hidden');
        }
        
        function hideTeamsLogin() {
            document.getElementById('teams-login').classList.add('hidden');
        }
        
        function showMainApp() {
            hideLoading();
            hideTeamsLogin();
            const iframe = document.getElementById('app-frame');
            iframe.src = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
            log('åŠ è½½ä¸»åº”ç”¨');
        }
        
        // ç¯å¢ƒæ£€æµ‹
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            const currentURL = window.location.href;
            const referrer = document.referrer;
            const isInIframe = window.parent !== window.self;
            const hasTeamsParam = new URLSearchParams(window.location.search).get('teams') === 'true';
            
            log(`ç”¨æˆ·ä»£ç†: ${userAgent}`);
            log(`å½“å‰URL: ${currentURL}`);
            log(`å¼•ç”¨é¡µ: ${referrer}`);
            log(`åœ¨iframeä¸­: ${isInIframe}`);
            log(`Teamså‚æ•°: ${hasTeamsParam}`);
            
            // åˆ¤æ–­æ˜¯å¦åœ¨Teamsç¯å¢ƒä¸­
            const isTeamsUA = userAgent.includes('Teams') || userAgent.includes('SkypeTeams');
            const isTeamsReferrer = referrer.includes('teams.microsoft.com') || referrer.includes('teams.live.com');
            
            isTeamsEnvironment = hasTeamsParam || isTeamsUA || isTeamsReferrer || 
                               (isInIframe && (isTeamsUA || isTeamsReferrer));
            
            log(`Teamsç¯å¢ƒæ£€æµ‹ç»“æœ: ${isTeamsEnvironment}`);
            return isTeamsEnvironment;
        }
        
        // Teams SDKåŠ è½½
        function loadTeamsSDK() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('åŠ è½½Teams SDK...');
                
                const script = document.createElement('script');
                script.src = 'https://res.cdn.office.net/teams-js/2.19.0/js/MicrosoftTeams.min.js';
                script.onload = () => {
                    teamsSDKLoaded = true;
                    log('Teams SDKåŠ è½½æˆåŠŸ');
                    resolve();
                };
                script.onerror = () => {
                    log('Teams SDKåŠ è½½å¤±è´¥', 'ERROR');
                    reject(new Error('Teams SDKåŠ è½½å¤±è´¥'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Teamsåˆå§‹åŒ–
        function initializeTeams() {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('åˆå§‹åŒ–Teams...');
                
                try {
                    microsoftTeams.initialize(() => {
                        log('Teamsåˆå§‹åŒ–æˆåŠŸ');
                        
                        // é€šçŸ¥Teamsåº”ç”¨å·²åŠ è½½
                        microsoftTeams.appInitialization.notifyAppLoaded();
                        microsoftTeams.appInitialization.notifySuccess();
                        log('å·²é€šçŸ¥Teamsåº”ç”¨çŠ¶æ€');
                        
                        resolve();
                    });
                } catch (error) {
                    log(`Teamsåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'ERROR');
                    reject(error);
                }
            });
        }
        
        // Teams SSOç™»å½•
        function performTeamsSSO() {
            if (!teamsSDKLoaded || authInProgress) return;
            
            authInProgress = true;
            updateAuthStatus('æ­£åœ¨æ‰§è¡ŒTeams SSOç™»å½•...', 'info');
            
            // ç¦ç”¨æŒ‰é’®
            document.getElementById('sso-login-btn').disabled = true;
            document.getElementById('popup-login-btn').disabled = true;
            
            microsoftTeams.authentication.getAuthToken({
                successCallback: function(token) {
                    log(`SSOæˆåŠŸï¼Œtokené•¿åº¦: ${token.length}`);
                    updateAuthStatus('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
                    
                    // å»¶è¿Ÿä¸€ä¸‹å†è·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                },
                failureCallback: function(error) {
                    log(`SSOå¤±è´¥: ${JSON.stringify(error)}`, 'ERROR');
                    updateAuthStatus(`SSOç™»å½•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    
                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    authInProgress = false;
                    document.getElementById('sso-login-btn').disabled = false;
                    document.getElementById('popup-login-btn').disabled = false;
                },
                silent: false
            });
        }
        
        // å¼¹çª—ç™»å½•
        function performPopupLogin() {
            if (!teamsSDKLoaded || authInProgress) return;
            
            authInProgress = true;
            updateAuthStatus('æ­£åœ¨æ‰“å¼€ç™»å½•çª—å£...', 'info');
            
            // ç¦ç”¨æŒ‰é’®
            document.getElementById('sso-login-btn').disabled = true;
            document.getElementById('popup-login-btn').disabled = true;
            
            microsoftTeams.authentication.authenticate({
                url: 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io/auth',
                width: 600,
                height: 535,
                successCallback: function(result) {
                    log(`å¼¹çª—ç™»å½•æˆåŠŸ: ${result}`);
                    updateAuthStatus('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
                    
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                },
                failureCallback: function(reason) {
                    log(`å¼¹çª—ç™»å½•å¤±è´¥: ${reason}`, 'ERROR');
                    updateAuthStatus(`ç™»å½•å¤±è´¥: ${reason}`, 'error');
                    
                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    authInProgress = false;
                    document.getElementById('sso-login-btn').disabled = false;
                    document.getElementById('popup-login-btn').disabled = false;
                }
            });
        }
        
        // ä¸»åˆå§‹åŒ–æµç¨‹
        async function initialize() {
            log('åº”ç”¨å¼€å§‹åˆå§‹åŒ–');
            
            // æ£€æµ‹ç¯å¢ƒ
            const isTeams = detectEnvironment();
            
            if (isTeams) {
                updateLoadingStatus('æ£€æµ‹åˆ°Teamsç¯å¢ƒ');
                
                try {
                    // åŠ è½½Teams SDK
                    await loadTeamsSDK();
                    
                    // åˆå§‹åŒ–Teams
                    await initializeTeams();
                    
                    updateLoadingStatus('å°è¯•è‡ªåŠ¨SSOç™»å½•...');
                    
                    // å°è¯•é™é»˜SSO
                    microsoftTeams.authentication.getAuthToken({
                        successCallback: function(token) {
                            log(`è‡ªåŠ¨SSOæˆåŠŸï¼Œtokené•¿åº¦: ${token.length}`);
                            updateLoadingStatus('è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½...');
                            setTimeout(() => {
                                showMainApp();
                            }, 1000);
                        },
                        failureCallback: function(error) {
                            log(`è‡ªåŠ¨SSOå¤±è´¥: ${JSON.stringify(error)}`);
                            updateLoadingStatus('éœ€è¦æ‰‹åŠ¨ç™»å½•');
                            setTimeout(() => {
                                showTeamsLogin();
                            }, 1000);
                        },
                        silent: true // é™é»˜å°è¯•
                    });
                    
                } catch (error) {
                    log(`Teamsç¯å¢ƒåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'ERROR');
                    updateLoadingStatus('åˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•é€‰é¡¹');
                    setTimeout(() => {
                        showTeamsLogin();
                    }, 2000);
                }
                
            } else {
                // æ™®é€šæµè§ˆå™¨ç¯å¢ƒ
                updateLoadingStatus('æ£€æµ‹åˆ°æ™®é€šæµè§ˆå™¨ï¼Œé‡å®šå‘ä¸­...');
                log('æ™®é€šæµè§ˆå™¨ç¯å¢ƒï¼Œç›´æ¥é‡å®šå‘');
                
                setTimeout(() => {
                    window.location.href = 'https://ai-openwebcontainer.victoriousmeadow-5aedd328.eastasia.azurecontainerapps.io';
                }, 1500);
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('sso-login-btn').addEventListener('click', performTeamsSSO);
        document.getElementById('popup-login-btn').addEventListener('click', performPopupLogin);
        
        // è¶…æ—¶ä¿æŠ¤
        setTimeout(() => {
            if (!document.getElementById('loading').classList.contains('hidden')) {
                log('åˆå§‹åŒ–è¶…æ—¶ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢', 'WARNING');
                showTeamsLogin();
            }
        }, 15000);
        
        // å¼€å§‹åˆå§‹åŒ–
        initialize();
    </script>
</body>
</html>
